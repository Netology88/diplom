# Дипломная работа по профессии «Системный администратор - Матвей Храмов SYS-37»

## Содержание

- [Задача](#задача)
- [Инфраструктура](#инфраструктура)
  - [Сайт](#сайт)
  - [Мониторинг](#мониторинг)
  - [Логи](#логи)
  - [Сеть](#сеть)
  - [Резервное копирование](#резервное-копирование)
  - [Дополнительно](#дополнительно)
- [Выполнение работы](#выполнение-работы)
- [Критерии сдачи](#критерии-сдачи)
- [Как правильно задавать вопросы дипломному руководителю](#как-правильно-задать-вопросы-дипломному-руководителю)

## Задача

Ключевая задача — разработать отказоустойчивую инфраструктуру для сайта, включающую мониторинг, сбор логов и резервное копирование основных данных. Инфраструктура должна размещаться в Yandex Cloud и отвечать минимальным стандартам безопасности: запрещается выкладывать токен от облака в git. Используйте инструкцию.

Перед началом работы над дипломным заданием изучите [Инструкцию по экономии облачных ресурсов](https://github.com/Netology88/diplom/blob/main/src/inst-terraform.png).

## Инфраструктура

Для развёртки инфраструктуры используйте Terraform и Ansible.

Не используйте для Ansible inventory IP-адреса! Вместо этого используйте FQDN имена виртуальных машин в зоне ".ru-central1.internal". Пример: `example.ru-central1.internal`.

Важно: используйте минимальные конфигурации ВМ: 2 ядра 20% Intel Ice Lake, 2-4 Гб памяти, 10 HDD, прерываемая.

Так как прерываемая ВМ проработает не больше 24 часов, перед сдачей работы на проверку дипломному руководителю сделайте ваши ВМ постоянно работающими.

![Пример конфигурации](https://raw.githubusercontent.com/Netology88/diplom/main/src/ansible-ping.png)
![Terraform инсталляция](https://raw.githubusercontent.com/Netology88/diplom/main/src/inst-terraform.png)

## Сайт

1. Создайте две ВМ в разных зонах, установите на них сервер Nginx, если его там нет. ОС и содержимое ВМ должно быть идентичным.
2. Используйте набор статичных файлов для сайта. Можно переиспользовать сайт из домашнего задания.

Выполнение сайта: созданы разные слова для наглядности работы балансировщика.

![Веб-страница 1](https://raw.githubusercontent.com/Netology88/diplom/main/src/scr-web1.png)
![Веб-страница 2](https://raw.githubusercontent.com/Netology88/diplom/main/src/scr-web2.png)

3. Создайте Target Group и включите в неё две созданные ВМ.

![Target Group](https://raw.githubusercontent.com/Netology88/diplom/main/src/target-group.png)

4. Создайте Backend Group, настройте backends на target group, ранее созданную. Настройте healthcheck на корень (/) и порт 80, протокол HTTP.

![Backend Group](https://raw.githubusercontent.com/Netology88/diplom/main/src/http-router1.png)

5. Создайте HTTP router. Путь укажите — `/`, backend group — созданную ранее.

![HTTP Router](https://raw.githubusercontent.com/Netology88/diplom/main/src/http-router.png)

6. Создайте Application load balancer для распределения трафика на веб-сервера, созданные ранее. Укажите HTTP router, созданный ранее, задайте listener тип auto, порт 80.

![Load Balancer](https://raw.githubusercontent.com/Netology88/diplom/main/src/load-balabcer.png)
![Load Balancer 2](https://raw.githubusercontent.com/Netology88/diplom/main/src/load-b-1.png)

7. Протестируйте сайт с помощью команды:
   ```bash
   curl -v <публичный IP балансера>:80

Мониторинг

    Создайте ВМ, разверните на ней Zabbix.

    На каждую ВМ установите Zabbix Agent, настройте агентов на отправление метрик в Zabbix.

Настройте дешборды с отображением метрик, минимальный набор — по принципу USE (Utilization, Saturation, Errors) для CPU, RAM, дисков, сети, http-запросов к веб-серверам. Добавьте необходимые tresholds на соответствующие графики.

В моём случае я развернул систему на связке Prometheus и Grafana. Результат следующий:

Затем скопировав получившийся шифр, заменил на значение в переменной pass в директории vars. В плейбуке у меня остались переменные {{ pass }}, и теперь в них передаётся именно тот шифр, который был создан ранее. Чтобы Ansible понял, что переменная зашифрована, её нужно расшифровать. Т.е. нужно запускать плейбук вот такой командой:

ansible-playbook --vault-id @prompt install_all.yml

Логи

    Создайте ВМ, разверните на ней Elasticsearch.

    Установите Filebeat на ВМ с веб-серверами и настройте на отправку access.log, error.log Nginx в Elasticsearch.

    Создайте ВМ, разверните на ней Kibana, сконфигурируйте соединение с Elasticsearch.

Логи с серверов через Elasticsearch в Kibana.

Сеть

    Разверните один VPC. Сервера web, Elasticsearch поместите в приватные подсети. Сервера Zabbix, Kibana, Application Load Balancer определите в публичную подсеть.

    Настройте Security Groups соответствующих сервисов на входящий трафик только к нужным портам.

    Настройте ВМ с публичным адресом, в которой будет открыт только один порт — SSH. Эта ВМ будет реализовывать концепцию bastion host (Jump host). Подключение Ansible к серверам web и Elasticsearch через данный bastion host можно сделать с помощью ProxyCommand. Допускается установка и запуск Ansible непосредственно на bastion host (этот вариант легче в настройке).

Резервное копирование

    Создайте snapshot дисков всех ВМ.

    Ограничьте время жизни snapshot в неделю.

    Сами snapshot настройте на ежедневное копирование.

Обзор облачного построения

![Обзор 1](https://raw.githubusercontent.com/Netology88/diplom/main/src/disc-vm-ya.png)
![Обзор 2](https://raw.githubusercontent.com/Netology88/diplom/main/src/http-router.png)
![Обзор 3](https://raw.githubusercontent.com/Netology88/diplom/main/src/http-router1.png)
![Обзор 4](https://raw.githubusercontent.com/Netology88/diplom/main/src/ip-addr-ya.png)
![Обзор 5](https://raw.githubusercontent.com/Netology88/diplom/main/src/route-tabl-ya.png)
![Обзор 6](https://raw.githubusercontent.com/Netology88/diplom/main/src/security-group-ya.png)
![Обзор 7](https://raw.githubusercontent.com/Netology88/diplom/main/src/subnet-ya.png)
![Обзор 8](https://raw.githubusercontent.com/Netology88/diplom/main/src/vm-ya.png)
![Обзор 9](https://raw.githubusercontent.com/Netology88/diplom/main/src/zone-vpc-1.png)
![Обзор 10](https://raw.githubusercontent.com/Netology88/diplom/main/src/zone-vpc-2.png)
![Обзор 11](https://raw.githubusercontent.com/Netology88/diplom/main/src/zone-vpc-3.png)

