# Дипломная работа по профессии «Системный администратор - Матвей Храмов SYS-37»

## Содержание
1. [Задача](#задача)
2. [Инфраструктура](#инфраструктура)
    - [Сайт](#сайт)
    - [Мониторинг](#мониторинг)
    - [Логи](#логи)
    - [Сеть](#сеть)
    - [Резервное копирование](#резервное-копирование)
    - [Дополнительно](#дополнительно)
3. [Выполнение работы](#выполнение-работы)
4. [Критерии сдачи](#критерии-сдачи)
5. [Как правильно задавать вопросы дипломному руководителю](#как-правильно-задавать-вопросы-дипломному-руководителю)

---

## Задача

Ключевая задача — разработать отказоустойчивую инфраструктуру для сайта, включающую мониторинг, сбор логов и резервное копирование основных данных. Инфраструктура должна размещаться в Yandex Cloud и отвечать минимальным стандартам безопасности: запрещается выкладывать токен от облака в git. Используйте инструкцию.

Перед началом работы над дипломным заданием изучите **Инструкцию по экономии облачных ресурсов**.

---

## Инфраструктура

Для развёртки инфраструктуры используйте **Terraform** и **Ansible**.

Не используйте для ansible inventory IP-адреса! Вместо этого используйте FQDN имена виртуальных машин в зоне ".ru-central1.internal". Пример: `example.ru-central1.internal`.

Важно: используйте минимальные конфигурации ВМ:
- 2 ядра 20% Intel Ice Lake
- 2-4 ГБ памяти
- 10 ГБ HDD
- Прерываемая ВМ

Так как прерываемая ВМ проработает не больше 24 часов, перед сдачей работы сделайте ВМ постоянно работающими.

---

### Сайт

Создайте две ВМ в разных зонах, установите на них сервер **nginx**, если его там нет. ОС и содержимое ВМ должно быть идентичным, это будут наши веб-сервера.

Используйте набор статичных файлов для сайта. Можно переиспользовать сайт из домашнего задания.

Выполнение сайта: 

Изменены слова на сайте для наглядности работы балансировщика:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/scr-web1.png)
![Alt text](https://github.com/Netology88/diplom/blob/main/src/scr-web2.png)

Создайте **Target Group**, включите в неё две созданных ВМ.

Выполнение Target Group:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/target-group.png)

Создайте **Backend Group**, настройте backends на Target Group, ранее созданную. Настройте healthcheck на корень (/) и порт 80, протокол HTTP.

Выполнение бэкенда:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/http-router1.png)

Создайте **HTTP Router**. Путь укажите — `/`, backend group — созданную ранее.

Выполнение HTTP Router:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/http-router.png)

Создайте **Application Load Balancer** для распределения трафика на веб-сервера. Укажите HTTP Router, созданный ранее, задайте listener тип auto, порт 80.

Выполнение Load Balancer:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/load-balabcer.png)
![Alt text](https://github.com/Netology88/diplom/blob/main/src/load-b-1.png)

Протестируйте сайт с помощью команды:

curl -v <публичный IP балансера>:80


Тест curl:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/curl.png)

---

### Мониторинг

Создайте ВМ, разверните на ней **Zabbix**. На каждую ВМ установите **Zabbix Agent**, настройте агентов на отправление метрик в Zabbix.

Настройте дешборды с отображением метрик, минимальный набор — по принципу USE (Utilization, Saturation, Errors) для:
- CPU
- RAM
- Диски
- Сеть
- HTTP запросы к веб-серверам

Добавьте необходимые tresholds на соответствующие графики.

В моём случае я развернул систему на связке **Prometheus** и **Grafana**. Результат следующий:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/prometheus-node-exporter.png)
![Alt text](https://github.com/Netology88/diplom/blob/main/src/encr.png)

Затем, скопировав получившийся шифр, заменил на значение в переменной `pass` в директории `vars`. В пелйбуке остались переменные `{{ pass }}`, и теперь передаётся именно тот шифр, который был создан ранее. Чтобы ansible понял, что переменная зашифрована, её нужно расшифровать, т.е. нужно запускать плейбук вот такой командой:

ansible-playbook --vault-id @prompt install_all.yml


![Alt text](https://github.com/Netology88/diplom/blob/main/src/graf-ans.png)

---

### Логи

Создайте ВМ, разверните на ней **Elasticsearch**. Установите **Filebeat** в ВМ к веб-серверам, настройте на отправку `access.log`, `error.log` nginx в Elasticsearch.

Создайте ВМ, разверните на ней **Kibana**, сконфигурируйте соединение с Elasticsearch.

Логи с серверов через Elasticsearch в Kibana:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/kibana-logs.png)

---

### Сеть

Разверните один **VPC**. Сервера **web**, **Elasticsearch** поместите в приватные подсети. Сервера **Zabbix**, **Kibana**, **Application Load Balancer** определите в публичную подсеть.

Настройте **Security Groups** соответствующих сервисов на входящий трафик только к нужным портам.

Настройте ВМ с публичным адресом, в которой будет открыт только один порт — **SSH**. Эта ВМ будет реализовывать концепцию **Bastion Host** (также известен как **Jump Host**). Подключение ansible к серверам **web** и **Elasticsearch** через данный Bastion Host можно сделать с помощью **ProxyCommand**. Допускается установка и запуск ansible непосредственно на bastion host.

---

### Резервное копирование

Создайте **snapshot** дисков всех ВМ. Ограничьте время жизни snapshot в неделю. Настройте snapshot на ежедневное копирование.

Snapshots:

![Alt text](https://github.com/Netology88/diplom/blob/main/src/snapshots.png)
![Alt text](https://github.com/Netology88/diplom/blob/main/src/snap2.png)

---

## Обзор облачного построения

- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/disc-vm-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/http-router.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/http-router1.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/ip-addr-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/route-tabl-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/security-group-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/subnet-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/vm-ya.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/zone-vpc-1.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/zone-vpc-2.png)
- ![Alt text](https://github.com/Netology88/diplom/blob/main/src/zone-vpc-3.png)
